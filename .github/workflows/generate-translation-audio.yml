name: Generate Audio from Translation

on:
  push:
    paths:
      - processed/**  # Automatically trigger on new files in the processed directory
  workflow_dispatch:
    inputs:
      file_date:
        description: "Date of the file to process (YYYY-MM-DD)"
        required: false

jobs:
  generate-audio:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.x"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests fugashi unidic-lite

    - name: Process translation file
      env:
        ELEVEN_LABS_API_KEY: ${{ secrets.ELEVEN_LABS_API_KEY }}
      run: |
        mkdir -p processed-audio
        python <<EOF
        import os
        import re
        from datetime import datetime
        import requests
        import fugashi  # For tokenizing Japanese text

        # Helper function to convert Kanji to Hiragana/Katakana
        def kanji_to_hiragana_katakana(text):
            tagger = fugashi.Tagger()
            result = []
            for token in tagger(text):
                kana = token.feature.kana or token.surface  # Convert Kanji to Kana
                if kana:
                    if token.feature.katakana:  # Preserve Katakana for loanwords
                        result.append(token.surface)  # Keep Katakana as-is
                    else:
                        result.append(kana)  # Convert everything else to Hiragana
            return ''.join(result)

        # Get inputs
        input_date = "${{ github.event.inputs.file_date }}" or datetime.utcnow().strftime("%Y-%m-%d")
        workspace = os.getenv("GITHUB_WORKSPACE", ".")
        processed_dir = os.path.join(workspace, "processed")
        processed_audio_dir = os.path.join(workspace, "processed-audio")

        # Find the target file
        target_file = os.path.join(processed_dir, f"{input_date}.txt")
        if not os.path.exists(target_file):
            print(f"Error: File '{target_file}' does not exist.")
            exit(1)

        # Extract "1. Translation" section
        with open(target_file, "r", encoding="utf-8") as file:
            content = file.read()

        # Use regex for fuzzy matching to extract the translation section
        match = re.search(
            r"1[.\s]*(?:\*\*Translation\*\*|Translation):?\s*(.*?)(?=\n[2-9][.\s]|$)", 
            content, 
            re.S
        )
        if not match:
            print(f"Error: '1. Translation' section not found in {target_file}.")
            exit(1)

        translation = match.group(1).strip()
        print(f"Original translation to process: {translation}")

        # Convert Kanji text to a mix of Hiragana/Katakana
        processed_translation = kanji_to_hiragana_katakana(translation)
        print(f"Processed translation to process: {processed_translation}")

        # Load API key and set headers
        ELEVEN_LABS_API_KEY = os.getenv("ELEVEN_LABS_API_KEY")
        if not ELEVEN_LABS_API_KEY:
            print("Error: ELEVEN_LABS_API_KEY is not set.")
            exit(1)

        VOICE_ID = "3JDquces8E8bkmvbh6Bc"  # Voice ID
        API_URL = f"https://api.elevenlabs.io/v1/text-to-speech/{VOICE_ID}"
        headers = {
            "xi-api-key": ELEVEN_LABS_API_KEY.strip(),
            "Content-Type": "application/json",
        }

        # Generate audio
        payload = {
            "text": processed_translation,
            "voice_settings": {
                "stability": 1.0,       # Maximum stability for consistent pronunciation
                "similarity_boost": 0.0 # Neutral tone for the voice
            }
        }

        response = requests.post(API_URL, json=payload, headers=headers)
        if response.status_code == 200:
            os.makedirs(processed_audio_dir, exist_ok=True)
            base_filename = os.path.basename(target_file).replace(".txt", "")
            output_path = os.path.join(processed_audio_dir, f"{base_filename}-audio.mp3")
            with open(output_path, "wb") as audio_file:
                audio_file.write(response.content)
            print(f"Audio saved to {output_path}")
        else:
            print("Error generating audio:", response.text)
            exit(1)
        EOF

    - name: Verify generated audio
      run: |
        echo "Checking processed-audio directory contents:"
        ls -l processed-audio || echo "No files generated"

    - name: Commit and push audio files
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add processed-audio/*.mp3
        git commit -m "Add generated audio file for translation"
        git push
